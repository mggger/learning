<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>时间 - 学习笔记</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li><a href="../scala/about.html"><strong aria-hidden="true">1.</strong> scala</a></li><li><ol class="section"><li><a href="../scala/f.html"><strong aria-hidden="true">1.1.</strong> 函数式编程</a></li><li><ol class="section"><li><a href="../scala/functional/theory.html"><strong aria-hidden="true">1.1.1.</strong> 理论</a></li></ol></li><li><a href="../scala/feature/feature.html"><strong aria-hidden="true">1.2.</strong> 一些特性</a></li><li><ol class="section"><li><a href="../scala/feature/lazy.html"><strong aria-hidden="true">1.2.1.</strong> lazy</a></li></ol></li><li><a href="../scala/akka.html"><strong aria-hidden="true">1.3.</strong> akka</a></li><li><ol class="section"><li><a href="../scala/akka/future.html"><strong aria-hidden="true">1.3.1.</strong> future</a></li><li><a href="../scala/akka/distribute.html"><strong aria-hidden="true">1.3.2.</strong> 分布式</a></li><li><a href="../scala/akka/config_log.html"><strong aria-hidden="true">1.3.3.</strong> 配置与日志</a></li><li><a href="../scala/akka/structure.html"><strong aria-hidden="true">1.3.4.</strong> Actor的结构模式</a></li><li><a href="../scala/akka/router.html"><strong aria-hidden="true">1.3.5.</strong> 路由消息</a></li><li><a href="../scala/akka/channel.html"><strong aria-hidden="true">1.3.6.</strong> 消息通道</a></li><li><a href="../scala/akka/stream.html"><strong aria-hidden="true">1.3.7.</strong> 流</a></li><li><a href="../scala/akka/profile.html"><strong aria-hidden="true">1.3.8.</strong> 性能调优</a></li></ol></li><li><a href="../scala/concurrancy/about.html"><strong aria-hidden="true">1.4.</strong> java并发基础</a></li><li><a href="../scala/jvm/about.html"><strong aria-hidden="true">1.5.</strong> jvm</a></li><li><ol class="section"><li><a href="../scala/jvm/gc.html"><strong aria-hidden="true">1.5.1.</strong> 垃圾回收</a></li><li><a href="../scala/jvm/jmh.html"><strong aria-hidden="true">1.5.2.</strong> jmh</a></li></ol></li><li><a href="../scala/sbt.html"><strong aria-hidden="true">1.6.</strong> sbt</a></li></ol></li><li><a href="../kafka/index.html"><strong aria-hidden="true">2.</strong> kafka</a></li><li><ol class="section"><li><a href="../kafka/chapter_1.html"><strong aria-hidden="true">2.1.</strong> kafka使用场景</a></li><li><a href="../kafka/chapter_2.html"><strong aria-hidden="true">2.2.</strong> kafka使用指南-生产者</a></li><li><a href="../kafka/chapter_3.html"><strong aria-hidden="true">2.3.</strong> kafka使用指南-消费者</a></li><li><a href="../kafka/chapter_4.html"><strong aria-hidden="true">2.4.</strong> 消息可靠性保证</a></li><li><ol class="section"><li><a href="../kafka/chapter_4_1.html"><strong aria-hidden="true">2.4.1.</strong> 生产者</a></li><li><a href="../kafka/chapter_4_2.html"><strong aria-hidden="true">2.4.2.</strong> 消费者</a></li></ol></li><li><a href="../kafka/kafka-streaming.html"><strong aria-hidden="true">2.5.</strong> kafka-streams</a></li><li><ol class="section"><li><a href="../kafka/kafka-state.html"><strong aria-hidden="true">2.5.1.</strong> 流和状态</a></li><li><a href="../kafka/join.html"><strong aria-hidden="true">2.5.2.</strong> join</a></li><li><a href="../kafka/timestamp.html"><strong aria-hidden="true">2.5.3.</strong> 时间戳</a></li><li><a href="../kafka/ktable.html"><strong aria-hidden="true">2.5.4.</strong> KTable</a></li><li><a href="../kafka/watch.html"><strong aria-hidden="true">2.5.5.</strong> 性能测量</a></li><li><a href="../kafka/transaction.html"><strong aria-hidden="true">2.5.6.</strong> 精确一次处理语义</a></li></ol></li></ol></li><li><a href="../druid/about.html"><strong aria-hidden="true">3.</strong> druid</a></li><li><ol class="section"><li><a href="../druid/source/source.html"><strong aria-hidden="true">3.1.</strong> 源码学习</a></li><li><ol class="section"><li><a href="../druid/source/maven.html"><strong aria-hidden="true">3.1.1.</strong> maven</a></li><li><a href="../druid/source/debug.html"><strong aria-hidden="true">3.1.2.</strong> 调试</a></li><li><a href="../druid/source/3libs.html"><strong aria-hidden="true">3.1.3.</strong> 第三方库</a></li><li><ol class="section"><li><a href="../druid/source/google_guice.html"><strong aria-hidden="true">3.1.3.1.</strong> google guice</a></li><li><a href="../druid/source/curator.html"><strong aria-hidden="true">3.1.3.2.</strong> curator</a></li><li><a href="../druid/source/jackson.html"><strong aria-hidden="true">3.1.3.3.</strong> jackson</a></li></ol></li></ol></li><li><a href="../druid/deploy/deploy.html"><strong aria-hidden="true">3.2.</strong> 运维</a></li><li><ol class="section"><li><a href="../druid/deploy/docker.html"><strong aria-hidden="true">3.2.1.</strong> docker</a></li></ol></li></ol></li><li><a href="../flink/infra.html"><strong aria-hidden="true">4.</strong> flink</a></li><li><ol class="section"><li><a href="../flink/process.html"><strong aria-hidden="true">4.1.</strong> 流式应用</a></li><li><a href="../flink/state.html"><strong aria-hidden="true">4.2.</strong> 状态管理</a></li><li><a href="../flink/time.html" class="active"><strong aria-hidden="true">4.3.</strong> 时间</a></li><li><a href="../flink/join.html"><strong aria-hidden="true">4.4.</strong> join</a></li><li><a href="../flink/algebra.html"><strong aria-hidden="true">4.5.</strong> 关系代数</a></li><li><a href="../flink/calcite.html"><strong aria-hidden="true">4.6.</strong> apache calcite</a></li></ol></li><li><a href="../spark/about.html"><strong aria-hidden="true">5.</strong> spark</a></li><li><ol class="section"><li><a href="../spark/sparksql.html"><strong aria-hidden="true">5.1.</strong> SparkSql</a></li><li><a href="../spark/antlr.html"><strong aria-hidden="true">5.2.</strong> Antlr</a></li><li><a href="../spark/optimized_in_prod.html"><strong aria-hidden="true">5.3.</strong> 常用优化手段</a></li><li><a href="../spark/deploy.html"><strong aria-hidden="true">5.4.</strong> spark on k8s</a></li></ol></li><li><a href="../microservices/about.html"><strong aria-hidden="true">6.</strong> 微服务</a></li><li><ol class="section"><li><a href="../microservices/kong/about.html"><strong aria-hidden="true">6.1.</strong> kong</a></li><li><ol class="section"><li><a href="../microservices/kong/jwt.html"><strong aria-hidden="true">6.1.1.</strong> jwt plugin</a></li></ol></li></ol></li><li><a href="../k8s/k8s/about.html"><strong aria-hidden="true">7.</strong> k8s</a></li><li><ol class="section"><li><a href="../k8s/k8s/label.html"><strong aria-hidden="true">7.1.</strong> 标签</a></li><li><a href="../k8s/k8s/probe.html"><strong aria-hidden="true">7.2.</strong> 探针</a></li><li><a href="../k8s/k8s/deamonset.html"><strong aria-hidden="true">7.3.</strong> DeamonSet</a></li><li><a href="../k8s/k8s/job.html"><strong aria-hidden="true">7.4.</strong> job</a></li><li><a href="../k8s/k8s/svc.html"><strong aria-hidden="true">7.5.</strong> svc</a></li><li><a href="../k8s/k8s/disk.html"><strong aria-hidden="true">7.6.</strong> 将磁盘挂载到容器</a></li><li><a href="../k8s/k8s/disruptions.html"><strong aria-hidden="true">7.7.</strong> Disruptions</a></li><li><a href="../k8s/k8s/stateful.html"><strong aria-hidden="true">7.8.</strong> stateful service</a></li><li><a href="../k8s/k8s/configMap.html"><strong aria-hidden="true">7.9.</strong> configMap</a></li><li><a href="../k8s/helm.html"><strong aria-hidden="true">7.10.</strong> Helm</a></li></ol></li><li><a href="../design/about.html"><strong aria-hidden="true">8.</strong> 设计模式</a></li><li><ol class="section"><li><a href="../design/uml.html"><strong aria-hidden="true">8.1.</strong> 深入浅出UML类图</a></li><li><a href="../design/create.html"><strong aria-hidden="true">8.2.</strong> 创建型模式</a></li><li><a href="../design/structure.html"><strong aria-hidden="true">8.3.</strong> 结构性模式</a></li><li><a href="../design/behavior.html"><strong aria-hidden="true">8.4.</strong> 行为模式</a></li></ol></li><li><a href="../postgres/about.html"><strong aria-hidden="true">9.</strong> postgres</a></li><li><ol class="section"><li><a href="../postgres/mvcc.html"><strong aria-hidden="true">9.1.</strong> MVCC</a></li><li><a href="../postgres/index.html"><strong aria-hidden="true">9.2.</strong> 索引</a></li><li><a href="../postgres/statistics.html"><strong aria-hidden="true">9.3.</strong> 统计信息</a></li><li><a href="../postgres/partition.html"><strong aria-hidden="true">9.4.</strong> 分区</a></li></ol></li><li><a href="../algorithm/about.html"><strong aria-hidden="true">10.</strong> 算法</a></li><li><ol class="section"><li><a href="../algorithm/datastruct/about.html"><strong aria-hidden="true">10.1.</strong> 数据结构</a></li><li><ol class="section"><li><a href="../algorithm/datastruct/list.html"><strong aria-hidden="true">10.1.1.</strong> 链表</a></li><li><a href="../algorithm/datastruct/rbtree.html"><strong aria-hidden="true">10.1.2.</strong> 红黑树</a></li><li><a href="../algorithm/datastruct/lsm.html"><strong aria-hidden="true">10.1.3.</strong> lsm Tree</a></li></ol></li><li><a href="../algorithm/kmp.html"><strong aria-hidden="true">10.2.</strong> kmp</a></li><li><a href="../algorithm/topo_sort.html"><strong aria-hidden="true">10.3.</strong> 拓扑排序</a></li></ol></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">学习笔记</h1> 

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#时间" id="时间"><h1>时间</h1></a>
<p>在flink中时间可分为以下类型:</p>
<ul>
<li>ProcessingTime, 本地处理时间</li>
<li>EventTime,  事件里面携带的时间信息</li>
<li>IngestionTime, 摄入时间</li>
</ul>
<p>通过配置来采用时间类型</p>
<pre><code class="language-scala">val env = StreamExecutionEnvironment.getExecutionEnvironment
env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)
</code></pre>
<p>TimeCharacteristic有以下类型:</p>
<ul>
<li>TimeCharacteristic.EventTime</li>
<li>TimeCharacteristic.ProcessingTime</li>
</ul>
<a class="header" href="#watermarks" id="watermarks"><h2>WaterMarks</h2></a>
<p>Watermarks 用于在应用程序中导出每个任务的当前事件时间。</p>
<p>默认的watermark生成的间隔是200ms， 可以通过配置的方式来改变</p>
<pre><code class="language-scala">env.setAutoWatermarkInterval(5000)
</code></pre>
<hr />
<p>也可以通过datastream api来指定自定义的watermarks。</p>
<pre><code class="language-scala">val test: DataStream[T] = env
        .addSource(new xxx)
        .assignTimestampAndWatermarks(new MyAssigner())

</code></pre>
<p><strong>示例允许收到的事件事件落后5s</strong></p>
<pre><code class="language-scala">
import org.apache.flink.streaming.api.functions.timestamps.BoundedOutOfOrdernessTimestampExtractor
import org.apache.flink.streaming.api.windowing.time.Time


class TimeAssigner
  extends BoundedOutOfOrdernessTimestampExtractor[SensorReading](Time.seconds(5)) {

  /** Extracts timestamp from SensorReading. */
  override def extractTimestamp(r: SensorReading): Long = r.timestamp

}
</code></pre>
<hr />
<a class="header" href="#assignerwithpunctuatedwatermarks" id="assignerwithpunctuatedwatermarks"><h3>AssignerWithPunctuatedWatermarks</h3></a>
<p><strong>场景： 比如需要提取某一类元素的timestamp作为生成watermark的标准</strong></p>
<pre><code class="language-scala">import org.apache.flink.streaming.api.functions.AssignerWithPunctuatedWatermarks
import org.apache.flink.streaming.api.watermark.Watermark

class PunctuatedAssigner extends AssignerWithPunctuatedWatermarks[SensorReading] {


  val bound: Long = 60 * 1000
  override def checkAndGetNextWatermark(
    r: SensorReading,
    extractedTimestamp: Long
  ): Watermark = {
      if (r.id == &quot;sensor_1&quot;) {
       new Watermark(extractedTimestamp - bound)
      } else {
        null
      }
    }

  override def extractTimestamp(element: SensorReading, previousElementTimestamp: Long): Long =
    element.timestamp
}
</code></pre>
<a class="header" href="#处理延迟的事件" id="处理延迟的事件"><h4>处理延迟的事件</h4></a>
<p>Datastream api 提供三种方式处理落后的事件:</p>
<ul>
<li>丢弃落后的事件。     （默认的处理方式)</li>
<li>重定向落后的事件到一个独立流</li>
<li>计算结果也包含落后的事件</li>
</ul>
<a class="header" href="#重定向落后的事件到一个独立流" id="重定向落后的事件到一个独立流"><h5>重定向落后的事件到一个独立流</h5></a>
<pre><code class="language-scala">val d: DataStream[SensorReading] = env.addSource[SensorReading](new SensorSource)
        .keyBy(_.id)
        .timeWindow(Time.seconds(10))
        .sideOutputLateData(new OutputTag[SensorReading](&quot;late-events&quot;))
        .process()

val lateStream: DataStream[SensorReading] = d.getSideOutput(new OutputTag[SensorReading](&quot;late-events&quot;))
</code></pre>
<a class="header" href="#process-functions" id="process-functions"><h6>Process functions</h6></a>
<p>如果需要在处理的过程中访问timestamp和当前时间, 可以使用低价Api <code>process function</code></p>
<p>示例 map</p>
<pre><code class="language-scala">import org.apache.flink.streaming.api.functions.KeyedProcessFunction
import org.apache.flink.api.common.state.ValueState
import org.apache.flink.api.common.state.ValueStateDescriptor
import org.apache.flink.api.scala.typeutils.Types
import org.apache.flink.util.Collector



class TempIncreaseAlertFunction extends KeyedProcessFunction[String, SensorReading, String] {

  lazy val lastTemp: ValueState[Double] = getRuntimeContext.getState(
    new ValueStateDescriptor[Double](&quot;lastTemp&quot;, Types.of[Double])
  )

  lazy val currentTimer: ValueState[Long] =
    getRuntimeContext.getState(
      new ValueStateDescriptor[Long](&quot;timer&quot;, Types.of[Long])
    )

  override def processElement(
    r: SensorReading,
    ctx: KeyedProcessFunction[String, SensorReading, String]#Context,
    out: Collector[String]
  ): Unit ={
    val prevTemp = lastTemp.value()
    lastTemp.update(r.temperatrue)

    val curTimerTimeStamp = currentTimer.value()
    if (prevTemp == 0.0 || r.temperatrue &lt; prevTemp) {
      ctx.timerService().deleteEventTimeTimer(curTimerTimeStamp)
      currentTimer.clear()
    }
  }

  override def onTimer(
    timestamp: Long,
    ctx: KeyedProcessFunction[String, SensorReading, String]#OnTimerContext,
    out: Collector[String]
  ): Unit = {
    out.collect(&quot;xxx&quot;)
    currentTimer.clear()
  }



}
</code></pre>
<a class="header" href="#时间操作" id="时间操作"><h2>时间操作</h2></a>
<a class="header" href="#tumbling-windows" id="tumbling-windows"><h3>Tumbling Windows</h3></a>
<p>类似kafka-streams的跳跃窗口</p>
<p>示例:</p>
<pre><code class="language-scala">
d.window(TumblingProcessingTimeWindows.of(Time.seconds(1)))
</code></pre>
<a class="header" href="#sliding-winodws" id="sliding-winodws"><h3>Sliding Winodws</h3></a>
<p>类似kafka-streams的滑动窗口</p>
<p>示例:</p>
<pre><code class="language-scala">
d.window(SlindingProcessingTimeWindows.of(Time.hours(1), Time.minutes(15)))
</code></pre>
<a class="header" href="#session-windows" id="session-windows"><h3>Session Windows</h3></a>
<p>类似kafka-streams的会话窗口</p>
<p>示例:</p>
<pre><code class="language-scala">
d.window(EventTimeSessionWindows.withGap(Time.minutes(15)))


</code></pre>
<a class="header" href="#时间操作的process-function" id="时间操作的process-function"><h4>时间操作的process function</h4></a>
<p>主要实现下面的抽象类</p>
<pre><code class="language-java">public interface AggregateFunction&lt;IN, ACC, OUT&gt; extends Function, Serializable {

    // 创建一个累加器
    ACC createAccumulator();
    
    // 添加元素到累加器
    ACC add(IN value, ACC accumulator);

    // 计算结果
    OUT getResult(ACC accumulator);

    // 合并两个累加器
    ACC merge(ACC a, ACC b);
}
</code></pre>
<p>示例:</p>
<pre><code class="language-scala">class AvgTempFunction
  extends AggregateFunction[(String, Double), (String, Double, Int), (String, Double)] {

  override def createAccumulator() = {
    (&quot;&quot;, 0.0, 0)
  }

  override def add(in: (String, Double), acc: (String, Double, Int)) = {
    (in._1, in._2 + acc._2, 1 + acc._3)
  }

  override def getResult(acc: (String, Double, Int)) = {
    (acc._1, acc._2 / acc._3)
  }

  override def merge(acc1: (String, Double, Int), acc2: (String, Double, Int)) = {
    (acc1._1, acc1._2 + acc2._2, acc1._3 + acc2._3)
  }
}
</code></pre>
<a class="header" href="#更复杂的时间函数" id="更复杂的时间函数"><h5>更复杂的时间函数</h5></a>
<pre><code class="language-scala">case class MinMaxTemp(id: String, min: Double, max:Double, endTs: Long)

class HighAndLowTempProcessFunction
  extends ProcessWindowFunction[SensorReading, MinMaxTemp, String, TimeWindow] {

  override def process(
                        key: String,
                        ctx: Context,
                        vals: Iterable[SensorReading],
                        out: Collector[MinMaxTemp]): Unit = {

    val temps = vals.map(_.temperature)
    val windowEnd = ctx.window.getEnd

    out.collect(MinMaxTemp(key, temps.min, temps.max, windowEnd))
  }
}
</code></pre>
<a class="header" href="#累计的时间函数" id="累计的时间函数"><h5>累计的时间函数</h5></a>
<pre><code class="language-scala">val minMaxTempPerWindow2: DataStream[MinMaxTemp] = sensorData
      .map(r =&gt; (r.id, r.temperature, r.temperature))
      .keyBy(_._1)
      .timeWindow(Time.seconds(5))
      .reduce(
        // incrementally compute min and max temperature
        (r1: (String, Double, Double), r2: (String, Double, Double)) =&gt; {
          (r1._1, r1._2.min(r2._2), r1._3.max(r2._3))
        },
        // finalize result in ProcessWindowFunction
        new AssignWindowEndProcessFunction()
      )


class AssignWindowEndProcessFunction
  extends ProcessWindowFunction[(String, Double, Double), MinMaxTemp, String, TimeWindow] {

  override def process(
                        key: String,
                        ctx: Context,
                        minMaxIt: Iterable[(String, Double, Double)],
                        out: Collector[MinMaxTemp]): Unit = {

    val minMax = minMaxIt.head
    val windowEnd = ctx.window.getEnd
    out.collect(MinMaxTemp(key, minMax._2, minMax._3, windowEnd))
  }
}
</code></pre>
<a class="header" href="#一些组件" id="一些组件"><h6>一些组件</h6></a>
<p>trigger: 决定window的触发条件
evictor: 用于清理当前window的元素</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../flink/state.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../flink/join.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../flink/state.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../flink/join.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
