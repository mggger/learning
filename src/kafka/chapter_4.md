# 消息可靠性保证

kafka在可靠性方面作了以下保证:

- kafka可以保证分区消息的顺序
- 只有当消息被写入分区的所有同步副本时候， 它才会被认为是 "已提交"。
- 只要还有一个副本是活跃的， 那么已经提交的消息就不会被丢失.
- 消费者只能读取已经提交的消息.

## 复制

kafka的复制机制和分区的多副本架构是kafka可靠性保证的核心。

分区首领是同步副本， 跟随者副本需要满足以下条件才能被认为是同步的:

- 与zookeeper之前有一个活跃的会话
- 在过去的一段时间内(可配置)从首领那里获取过信息
- 在过去的一段时间内从首领那里获取过最新的消息

### broker的配置

broker有3个配置参数会影响kafka消息存储的可靠性。与其他配置参数一样， 它们可以应用在broker级别， 用于控制所有主题的行为， 也可以用在主题级别， 用于控制个别主题的行为。

#### 复制系数

topic级别的配置参数是replication.factor 
broker级别的配置参数是default.replication.factor

#### 不完全的首领选举
unclean.leader.election 只能在broker级别(cluster)进行配置， 默认值是true, 允许不同步的副本成为首领

完全选举： 分区首领不可用时候,  一个同步副本会选为新首领。如果在选举过程中没有丢失数据， 也就是说提交的数据同时存在于所有的同步副本上。

如果首领不可用时， 其他副本都是不同步的, 比如下面两种场景:
- 分区有3个副本， 其中的两个跟随者副本不可用， 这个时候， 如果生产者继续往首领写入数据， 所有消息都会得到确认并被提交。 假设首领不可用了， 另外一个跟随者重新启动， 它就成为了分区唯一的不同步脚本.
- 分区有3个副本， 因为网络原因导致两个副本落后于首领副本， 此时首领副本不可用了， 另外两个副本也无法变成同步

针对上面两种情况我们可以在可靠与可用之间作出选择：

- 可靠: 不允许不同步的副本成为首领， 接受较低的可用性                   
- 可用：允许不同步的副本成为首领， 接受承担丢失数据和出现数据不一致的风险

##### 参数总结
|参数|意义|
|---|----|
|replication.factor|topic级别的复制系数|
|default.replication.factor|broker级别的复制系数|
|unclean.leader.election|true允许不同步的副本成为首领|
|min.insync.replicas|最少同步副本|